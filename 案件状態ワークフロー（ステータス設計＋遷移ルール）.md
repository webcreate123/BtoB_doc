## 1. 案件ステータス一覧（標準ワークフロー）

```text
Lead
↓
Negotiating
↓
Contracted
↓
Paid（内部）
↓
Completed
```

※ UI 上は `Paid` を非表示にして `Completed` へ直行させてもOK
※ Admin用に例外ステータスを別枠で定義（後述）

---

## 2. 各ステータスの定義と責務

### ① Lead（リード）

**状態概要**

* Partner が案件を紹介した直後の状態
* Vendor 未対応 or 初期確認前

**主な操作主体**

* Partner（作成）
* Vendor（閲覧のみ）

**可能操作**

* Partner：案件登録
* Vendor：閲覧

**制約**

* 金額入力不可
* ステータス変更は Vendor のみ可能

---

### ② Negotiating（商談中）

**状態概要**

* Vendor が案件対応を開始
* 見積・条件調整フェーズ

**主な操作主体**

* Vendor

**可能操作**

* Vendor：

  * メモ追加
  * 進捗更新
  * 成約 or 差し戻し

**遷移**

* `Lead → Negotiating`（Vendor）

**制約**

* まだ金額ロックなし
* ここでキャンセル可能（`Cancelled`）

---

### ③ Contracted（成約）

**状態概要**

* 商談成立
* 売上金額（税込）が確定し、**ロジックがロック**される

**主な操作主体**

* Vendor

**可能操作**

* Vendor：

  * 売上金額入力
  * 報酬試算確認（Partner報酬／手数料／源泉）
  * 請求書発行

**処理内容**

* VA 発行（System自動）
* 請求書PDF生成
* 請求金額確定

**遷移**

* `Negotiating → Contracted`

**重要ロック**

* 金額・報酬計算ロジック固定
* サービス報酬率の変更はこの案件に影響しない
* 金額変更不可
* VAは案件単位で一意

---

### ④ Paid（内部ステータス）

**状態概要**

* Client の振込をシステムが検知した状態
* 分配・送金処理前後の中間状態

**主な操作主体**

* System（Webhook）

**処理内容**

* 入金Webhook検知
* 入金金額検証
* 分配計算実行

**UI扱い**

* Partner / Vendor には非表示
* Adminログのみ

---

### ⑥ Completed（完了）

**状態概要**

* 正常にすべての処理が完了
* Partner / Vendor へ送金完了

**主な操作主体**

* System

**処理内容**

* Partner送金
* Vendor送金
* ステータス確定

**遷移**

* `Contracted → Paid`（System自動）
* `Paid → Completed`

---

## 3. 例外・エラーステータス（Admin管理）

通常フローとは別に、**管理専用ステータス**を定義します。

### ⑦ Payment Error（入金エラー）

**発生条件**

* 入金金額不足
* 重複入金
* VA不一致

**対応**

* Admin が確認
* 手動補正 or 差戻し

---

### ⑧ Payout Error（送金エラー）

**発生条件**

* Partner / Vendor 口座エラー
* APIエラー

**対応**

* Admin が再送金実行

---

### ⑨ Cancelled（キャンセル）

**遷移可能元**

* Lead
* Negotiating

**制約**

* Contracted 以降は原則キャンセル不可（Adminのみ可）

---

## 4. ステータス × 操作主体マトリクス

| ステータス       | Partner | Vendor | Client | Admin | System |
| ----------- | ------- | ------ | ------ | ----- | ------ |
| Lead        | 作成      | 閲覧     | –      | 閲覧    | –      |
| Negotiating | 閲覧      | 更新     | –      | 閲覧    | –      |
| Contracted  | 閲覧      | 金額確定・請求発行 | 振込     | 閲覧    | VA発行   |
| Paid        | –       | –      | –      | 監視    | 分配     |
| Completed   | 閲覧      | 閲覧     | –      | 監視    | 送金     |
| Error系      | –       | –      | –      | 操作    | –      |

---

## 5. 実装向け補足（重要）

* **ステータス遷移は Vendor 主導 + System 自動**
* **金額ロックは Contracted 時点**
* **請求書・VAは Contracted 時に必ず確定**
* **入金検知＝即送金ではなく、必ず検証ステップを挟む**
