# BtoB紹介パートナープラットフォーム 基本設計書

## 1. プロジェクト概要

### 1.1. 開発の目的

BtoBビジネスにおける「紹介パートナー（代理店）制度」の運用コストを削減し、活性化させるプラットフォームを構築する。案件の紹介から成約までの進捗を可視化（SFA機能）し、銀行振込による売上入金をシステムが検知した瞬間に、紹介報酬をパートナーへ自動送金（FinTech機能）することで、経理業務の完全自動化を実現する。

### 1.2. コアバリュー

- **SFA × FinTech**: 進捗管理と決済が一体化したシームレスな体験
- **No Credit Card**: BtoB商習慣に即した「銀行振込（請求書払い）」への完全対応
- **Real-time Revenue Share**: 入金確認後の即時自動分配による、パートナーへの信頼性向上

## 2. システム全体設計と資金スキーム

### 2.1. 登場する主体の定義

| 主体 | 定義 | 役割 |
|------|------|------|
| **Admin** | プラットフォーム運営者 | 全体管理、手数料設定、エラー時の手動送金操作、ログ監視 |
| **Vendor** | 掲載企業（サービス提供者） | サービス登録、案件の商談、カンバン操作、請求書発行 |
| **Partner** | 紹介パートナー | 案件紹介（リード登録）、進捗確認、報酬受取 |
| **Client** | エンド顧客（支払者） | 請求書に基づき、案件専用のバーチャル口座へ入金（システム外） |

### 2.2. マネーフロー（収納代行モデル）

本システムはAdminがVendorの「収納代行」を行う建付けとする。

1. **請求**: Systemが「案件ごとのバーチャル口座」を発行し、Clientへ請求
2. **入金**: Clientからバーチャル口座へ入金
3. **着金**: Admin管理の銀行口座（親口座）に着金
4. **分配**: Systemが自動計算し、Admin口座から「Vendor」と「Partner」へ即時振込を実行

### 2.3. 利用外部API

**GMOあおぞらネット銀行 API**（参照系・更新系）

- バーチャル口座発行
- 入金通知Webhook
- 振込依頼（他行/自行宛て）

## 3. 機能要件詳細

### 3.1. 認証・ユーザー管理機能

- **会員登録/ログイン**: メールアドレス・パスワード認証
- **企業情報管理**: 法人名、適格請求書発行事業者番号（インボイス制度対応）
- **【重要】口座情報登録**:
  - 売上・報酬を受け取るための銀行口座情報
  - 口座名義カナのバリデーションチェック

### 3.2. 案件管理・SFA機能（Deal Management）

VendorとPartnerが進捗を共有するための機能群。

#### A. 案件データ構造

1つの案件（Deal）は以下の情報を持つ。

- **基本情報**: 案件名、エンド顧客情報（社名、担当者、連絡先）
- **紐付け**: 担当Vendor ID、担当Partner ID
- **契約条件**: 報酬タイプ（定率% or 定額￥）、報酬額/率
- **金額**: 見込金額、確定契約金額（税抜/税込）

#### B. ステータスワークフロー

以下のステータス遷移を実装する。

- **新規リード (New Lead)**: Partnerが登録、または紹介リンク経由で発生
- **商談中 (Negotiation)**: Vendorが対応中
- **見積提出済 (Quoted)**: 金額提示済み
- **契約締結/受注 (Contracted)**: ※ここで金額と報酬条件をロック（編集不可）にする
- **請求済 (Billed)**: ※この時点で「バーチャル口座」を発行する
- **入金完了 (Paid)**: 銀行APIが入金を検知
- **分配完了 (Distributed)**: 自動送金完了
- **失注 (Lost)**: 契約に至らず終了

#### C. コミュニケーション機能

- 案件ごとのチャットスレッド機能（Vendor ⇔ Partner）
- ステータス変更時のメール/LINE通知

### 3.3. 決済・自動分配機能（Billing & Payout）

本システムのコアとなる銀行API連携ロジック。

#### A. バーチャル口座発行ロジック

- **トリガー**: 案件ステータスが「請求済」に変更された時
- **処理**: 銀行APIを叩き、振込入金口座（支店・口座番号）を取得し、案件DBに保存
- **出力**: 請求書PDFに上記口座番号を自動印字

#### B. 入金消込・分配計算ロジック

- **トリガー**: 銀行からの入金通知Webhook受信時
- **照合**: Webhook内の「入金口座番号」と「入金額」をDBと照合
- **過不足判定**:
  - **一致**: 次の処理へ進む
  - **不足**: ステータスを「入金不足」とし、分配を保留（Adminへアラート）
  - **超過**: 超過分を含めて分配するか、プールするかをAdmin設定に従う（デフォルトは按分して分配）
- **計算式**:
  - Partner報酬 = (売上税抜 × 報酬率) + 消費税
  - Vendor受取額 = (入金総額) - (Partner報酬) - (Platform利用料)


#### C. 即時振込実行ロジック

- **トリガー**: 計算完了後、即時（ジョブキュー処理）
- **手数料処理**: 振込手数料（例:145円）は受取人負担とする
  - 実際の送金額 = 計算上の報酬額 - 振込手数料
- **最低支払額判定**:
  - 計算上の報酬額 < 最低支払額設定(例:1,000円) の場合、振込をスキップし、次回の売上まで「未払報酬（プール金）」としてDBに蓄積する


### 3.4. 管理画面・ダッシュボード

#### Partner画面

- **ホーム**: 今月の報酬額、進行中案件数
- **案件一覧**: カンバン形式またはリスト形式での進捗表示
- **ウォレット**: 振込履歴、支払通知書（PDF）ダウンロード

#### Vendor画面

- **リード管理**: 全Partnerからの紹介案件一覧
- **請求管理**: 請求書発行、支払い通知書発行、入金ステータス確認
- **アライアンス設定**: 報酬率のデフォルト設定、Partner承認/拒否

#### Admin画面

- **取引ログ**: 全ての入出金履歴、APIエラーログ
- **手動消込**: 何らかの理由で自動消込が失敗した際の強制ステータス変更機能
- **マスタ設定**: 振込手数料設定、消費税率設定

## 4. 非機能要件

### 4.1. 可用性・信頼性

- **24時間稼働**: モアタイムシステムにより夜間・休日も着金するため、サーバーは24時間稼働・監視を行う
- **冪等性の担保**: Webhookが重複して送信されてきた場合でも、二重計上・二重送金が起きない設計とする（Transaction IDによる排他制御）

### 4.2. セキュリティ

- **通信暗号化**: 全てSSL/TLS通信
- **APIキー管理**: 銀行APIのアクセストークンは、AWS Secrets Manager等のセキュアなストレージで厳重に管理する
- **操作ログ**: 金銭に関わる操作（口座変更、手動消込など）は全ての操作ログを保存する

### 4.3. パフォーマンス

- **処理速度**: 入金Webhook受信から振込指示完了まで、1分以内に完了すること

## 5. データベース設計（主要エンティティ案）

### users (Vendor/Partner共通)
- ID, Email, Role, CompanyName, BankAccountInfo

### deals (案件)
- ID, VendorID, PartnerID, ClientName, Status(Lead/Contracted/Paid...), Amount(契約額), CommissionRate(報酬率), CreatedAt

### invoices (請求書管理)
- ID, DealID, VirtualAccountNumber(バーチャル口座番号), BankBranch(支店), Amount, Status, IsActive

### transactions (入金トランザクション)
- ID, DealID, InvoiceID, DepositAmount(入金額), DepositDate, Status(Matched/Unmatched)

### payouts (出金/分配ログ)
- ID, TransactionID, RecipientUserID, Amount(送金額), Fee(手数料), TransferID, Status(Processing/Completed/Failed)

## 6. 今後の拡張性（Phase 2以降）

- **継続報酬（サブスク）対応**: 毎月定額の請求と分配を自動化する機能
- **API連携**: SalesforceやHubSpot等の外部CRMとのデータ連携
- **与信管理**: 請求書払い（後払い）の保証サービス連携

## 7. システムアーキテクチャ・技術選定（推奨構成）

お金を扱うシステムのため、「処理速度」よりも**「堅牢性（データの整合性）」と「セキュリティ」**を最優先した構成にします。

### 7.1. 推奨技術スタック

開発効率と安全性のバランスが良い構成案です。

- **フロントエンド**: Next.js (React) / TypeScript
  - 理由: ダッシュボードの操作性（SPA）と、SEO（LP部分）の両立。Vercel等でのデプロイが容易。
- **バックエンド**: Node.js (NestJS) または Go
  - 理由: 銀行APIとの非同期通信（Webhook処理）や、トランザクション処理に強い型安全性のある言語が望ましい。
- **データベース**: PostgreSQL
  - 理由: 金融システムで標準的なRDB。トランザクション制御（ACID特性）に信頼性がある。
- **インフラ**: AWS (ECS Fargate, RDS, Secrets Manager)
  - 理由: 銀行接続のための固定IP付与や、セキュリティ要件（WAF, 私設サブネット）に対応しやすい。

### 7.2. ネットワーク・セキュリティ構成

- **IP制限**: Admin管理画面は、特定のIPアドレス（社内VPN等）からのみアクセス可能にする。
- **WAF (Web Application Firewall)**: SQLインジェクションやXSS攻撃を防ぐ。
- **秘密鍵管理**: 銀行APIのクライアント証明書やアクセストークンは、コード内に直書きせず、環境変数またはAWS Secrets Managerで暗号化して管理する。

## 8. 画面遷移図・UI設計（Screen Flow）

SFA（進捗管理）と決済が混在するため、ユーザーごとの導線を整理します。

### 8.1. Partner（紹介者）のフロー

**「案件を登録して、放置しておけば報酬が入る」**という体験を目指します。

- **Dashboard**: 今月の報酬総額、進行中案件サマリを表示
- **案件登録 (New Deal)**:
  - 紹介先企業名、担当者名を入力
  - 紹介リンク発行（URLコピー）
- **案件詳細 (Deal Detail)**:
  - タイムライン表示（商談中→契約→請求済...）
  - Vendorへのチャット・コメント投稿
- **ウォレット (Wallet)**:
  - 入出金履歴（通帳のようなUI）
  - 支払通知書（インボイス対応PDF）のダウンロード

### 8.2. Vendor（掲載企業）のフロー

**「商談を進めて、請求ボタンを押すだけ」**という体験を目指します。

- **案件管理ボード (Kanban)**:
  - Trelloのようなカンバン形式で、リードをドラッグ&ドロップでステータス移動（商談中→見積提出）
- **請求書作成 (Billing)**:
  - システム内で請求書を作成する画面
  - **重要**: 「発行」ボタンを押すと、自動的に**「振込先：GMOあおぞらネット銀行 [専用支店] [専用番号]」**が印字されたPDFが生成される
- **パートナー承認 (Partner Settings)**:
  - 提携申請の承認/拒否
  - 個別報酬レートの設定（例：このパートナーだけ30%にする等）

## 9. 法的構成・利用規約（Legal Scheme）

システム開発と同じくらい重要なのが、「資金決済法違反」にならないための法的ロジックです。  
※必ず顧問弁護士のリーガルチェックを経て確定させてください。以下の条文構成は一般的な収納代行モデルのひな形です。

### 8.1. 収納代行に関する特約（Vendor向け）

プラットフォーム（あなた）が、Vendor（売り手）に代わって代金を受け取る根拠を作ります。

**第X条（収納代行および弁済の効力）**

ユーザー（Vendor）は、本サービスを通じて発生した取引について、プラットフォーム運営者（Admin）が代金の収納代行を行うことに同意する。AdminがClientから代金を受領した時点で、Vendorに対する弁済の効力が生じるものとする。
