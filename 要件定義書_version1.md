# BtoB紹介パートナープラットフォーム 基本設計書

## 1. プロジェクト概要

### 1.1. 開発の目的

BtoBビジネスにおける「紹介パートナー（代理店）制度」の運用コストを削減し、活性化させるプラットフォームを構築する。案件の紹介から成約までの進捗を可視化（SFA機能）し、銀行振込による売上入金をシステムが検知した瞬間に、紹介報酬をパートナーへ自動送金（FinTech機能）することで、経理業務の完全自動化を実現する。

### 1.2. コアバリュー

- **SFA × FinTech**: 進捗管理と決済が一体化したシームレスな体験
- **No Credit Card**: BtoB商習慣に即した「銀行振込（請求書払い）」への完全対応
- **Real-time Revenue Share**: 入金確認後の即時自動分配による、パートナーへの信頼性向上

## 2. システム全体設計と資金スキーム

### 2.1. 登場する主体の定義

| 主体 | 定義 | 役割 |
|------|------|------|
| **Admin** | プラットフォーム運営者 | 全体管理、手数料設定、エラー時の手動送金操作、ログ監視 |
| **Vendor** | 掲載企業（サービス提供者） | サービス登録、案件の商談、カンバン操作、請求書発行 |
| **Partner** | 紹介パートナー | 案件紹介（リード登録）、進捗確認、報酬受取 |
| **Client** | エンド顧客（支払者） | 請求書に基づき、案件専用のバーチャル口座へ入金（システム外） |

### 2.2. マネーフロー（収納代行モデル）

本システムはAdminがVendorの「収納代行」を行う建付けとする。

1. **請求**: SystemがStripe Invoicingを使用して「案件ごとの請求書」を発行し、Clientへ請求
2. **入金**: ClientからStripe経由で入金（口座振込等）
3. **着金**: Stripeアカウントに着金（入金通知Webhookで検知、口座名義情報も取得）
4. **分配**: Systemが自動計算し、Stripe Connectを使用して「Vendor」と「Partner」へ即時送金を実行

### 2.3. 利用外部API

**Stripe API**（参照系・更新系）

- Stripe Connect: パートナーへの送金機能
- Stripe Invoicing: 請求書発行と入金管理
- Stripe Webhooks: 入金通知（口座名義情報を含む）
- Stripe Transfers: パートナーへの即時送金

## 3. 機能要件詳細

### 3.1. 認証・ユーザー管理機能

- **会員登録/ログイン**: メールアドレス・パスワード認証
- **企業情報管理**: 法人名、適格請求書発行事業者番号（インボイス制度対応）
- **【重要】口座情報登録**:
  - 売上・報酬を受け取るための銀行口座情報
  - 口座名義カナのバリデーションチェック

### 3.2. 案件管理・SFA機能（Deal Management）

VendorとPartnerが進捗を共有するための機能群。

#### A. 案件データ構造

1つの案件（Deal）は以下の情報を持つ。

- **基本情報**: 案件名、エンド顧客情報（社名、担当者、連絡先）
- **紐付け**: 担当Vendor ID、担当Partner ID
- **契約条件**: 報酬タイプ（定率% or 定額￥）、報酬額/率
- **金額**: 見込金額、確定契約金額（税抜/税込）

#### B. ステータスワークフロー

以下のステータス遷移を実装する。

- **新規リード (New Lead)**: Partnerが登録、または紹介リンク経由で発生
- **商談中 (Negotiation)**: Vendorが対応中
- **見積提出済 (Quoted)**: 金額提示済み
- **契約締結/受注 (Contracted)**: ※ここで金額と報酬条件をロック（編集不可）にする
- **請求済 (Billed)**: ※この時点でStripe Invoicingを使用して「請求書」を発行する
- **入金完了 (Paid)**: Stripe Webhookが入金を検知（口座名義情報も取得し、仕入先名として表示）
- **分配完了 (Distributed)**: 自動送金完了
- **失注 (Lost)**: 契約に至らず終了

#### C. コミュニケーション機能

- 案件ごとのチャットスレッド機能（Vendor ⇔ Partner）
- ステータス変更時のメール/LINE通知

### 3.3. 決済・自動分配機能（Billing & Payout）

本システムのコアとなる銀行API連携ロジック。

#### A. 請求書発行・入金管理ロジック

- **トリガー**: 案件ステータスが「請求済」に変更された時
- **処理**: Stripe Invoicing APIを使用して請求書を発行し、案件専用の支払いリンクを生成
- **出力**: 請求書PDFにStripeの支払い情報（口座振込先情報）を自動印字
- **口座名義表示**: 入金通知時に送金者名（口座名義）を取得し、仕入先名として表示・保存

#### B. 入金消込・分配計算ロジック

- **トリガー**: Stripeからの入金通知Webhook受信時
- **照合**: Webhook内の「請求書ID」「入金額」「送金者名（口座名義）」をDBと照合
- **口座名義の処理**: 
  - Webhookから取得した送金者名（口座名義）を仕入先名（Client名）として表示・保存
  - 案件のClient情報が未登録または不一致の場合、口座名義を仕入先名として自動更新
- **過不足判定**:
  - **一致**: 次の処理へ進む
  - **不足**: ステータスを「入金不足」とし、分配を保留（Adminへアラート）
  - **超過**: 超過分を含めて分配するか、プールするかをAdmin設定に従う（デフォルトは按分して分配）

#### C. 分配計算エンジン（Calculation Logic）

誤差を排除するため、すべて「切り捨て」で算出し、確定後の変更を禁止する。

- **Partner報酬**: `(受注額(税込) / 1.1) * 報酬率 * 1.1` (切捨)
  - 個人の場合は報酬(税抜)から源泉10.21%を控除
- **システム手数料**: `受注額(税込) * 手数料率` (切捨)
- **Vendor受取額**: `受注額(税込) - (Partner報酬 + システム手数料)`
- **送金額**: それぞれの額から実費振込手数料を差し引く

#### D. 即時送金実行ロジック

- **トリガー**: 計算完了後、即時（ジョブキュー処理）
- **送金方法**: Stripe Connectを使用してパートナーアカウントへ即時送金
- **手数料処理**: Stripeの送金手数料は受取人負担とする
  - 実際の送金額 = 計算上の報酬額 - Stripe手数料
- **最低支払額判定**:
  - 計算上の報酬額 < 最低支払額設定(例:1,000円) の場合、送金をスキップし、次回の売上まで「未払報酬（プール金）」としてDBに蓄積する

#### E. カンバンUI

- **ステータス列**: Lead → Negotiating → Contracted → Billed → Completed の5列
- **制約**: Billed 以降は「左（前工程）」への移動を禁止し、金額変更もロックする

#### F. 帳票生成

- **請求書PDF**: 案件ごとに一意のStripe請求書ID、インボイス番号、内訳（10%対象・消費税等）を印字
- **支払通知書PDF**: 送金額の内訳、源泉徴収、手数料を明記
- **入金確認画面**: 送金者名（口座名義）を仕入先名として表示

### 3.4. 管理画面・ダッシュボード

#### Partner画面

- **ホーム**: 今月の報酬額、進行中案件数
- **案件一覧**: カンバン形式またはリスト形式での進捗表示
- **ウォレット**: 振込履歴、支払通知書（PDF）ダウンロード

#### Vendor画面

- **リード管理**: 全Partnerからの紹介案件一覧
- **請求管理**: 請求書発行、支払い通知書発行、入金ステータス確認
  - **入金確認**: 入金時に送金者名（口座名義）が仕入先名として自動表示される
- **アライアンス設定**: 報酬率のデフォルト設定、Partner承認/拒否

#### Admin画面

- **取引ログ**: 全ての入出金履歴、APIエラーログ
- **手動消込**: 何らかの理由で自動消込が失敗した際の強制ステータス変更機能
- **マスタ設定**: 振込手数料設定、消費税率設定

## 4. 非機能要件

### 4.1. 可用性・信頼性

- **24時間稼働**: モアタイムシステムにより夜間・休日も着金するため、サーバーは24時間稼働・監視を行う
- **冪等性の担保**: Webhookが重複して送信されてきた場合でも、二重計上・二重送金が起きない設計とする（Transaction IDによる排他制御）

### 4.2. セキュリティ

- **通信暗号化**: 全てSSL/TLS通信
- **APIキー管理**: Stripe APIのシークレットキーは、AWS Secrets Manager等のセキュアなストレージで厳重に管理する
- **操作ログ**: 金銭に関わる操作（口座変更、手動消込など）は全ての操作ログを保存する

### 4.3. パフォーマンス

- **処理速度**: Stripe入金Webhook受信から送金指示完了まで、1分以内に完了すること

## 5. データベース設計（主要エンティティ案）

### users (Vendor/Partner共通)
- ID, Email, Role, CompanyName, BankAccountInfo

### deals (案件)
- ID, VendorID, PartnerID, ClientName, Status(Lead/Contracted/Paid...), Amount(契約額), CommissionRate(報酬率), CreatedAt

### invoices (請求書管理)
- ID, DealID, StripeInvoiceID, PaymentLink, Amount, Status, RemitterName(口座名義/仕入先名), IsActive

### transactions (入金トランザクション)
- ID, DealID, InvoiceID, StripePaymentIntentID, DepositAmount(入金額), DepositDate, RemitterName(口座名義/仕入先名), Status(Matched/Unmatched)

### payouts (出金/分配ログ)
- ID, TransactionID, RecipientUserID, Amount(送金額), Fee(手数料), StripeTransferID, Status(Processing/Completed/Failed)

## 6. システムアーキテクチャ・技術選定（推奨構成）

お金を扱うシステムのため、「処理速度」よりも**「堅牢性（データの整合性）」と「セキュリティ」**を最優先した構成にします。

### 6.1. 推奨技術スタック

- **フロントエンド**: Next.js / TypeScript（Vercel等でのデプロイが容易）
- **バックエンド**: Go
- **データベース**: PostgreSQL
- **インフラ**: AWS (ECS Fargate, RDS, Secrets Manager)

## 7. 画面遷移図・UI設計（Screen Flow）

SFA（進捗管理）と決済が混在するため、ユーザーごとの導線を整理します。

### 7.1. Partner（紹介者）のフロー

**「案件を登録して、放置しておけば報酬が入る」**という体験を目指します。

- **Dashboard**: 今月の報酬総額、進行中案件サマリを表示
- **案件登録 (New Deal)**:
  - 紹介先企業名、担当者名を入力
  - 紹介リンク発行（URLコピー）
- **案件詳細 (Deal Detail)**:
  - タイムライン表示（商談中→契約→請求済...）
  - Vendorへのチャット・コメント投稿
- **ウォレット (Wallet)**:
  - 入出金履歴（通帳のようなUI）
  - 支払通知書（インボイス対応PDF）のダウンロード

### 7.2. Vendor（掲載企業）のフロー

**「商談を進めて、請求ボタンを押すだけ」**という体験を目指します。

- **案件管理ボード (Kanban)**:
  - Trelloのようなカンバン形式で、リードをドラッグ&ドロップでステータス移動（商談中→見積提出）
- **請求書作成 (Billing)**:
  - システム内で請求書を作成する画面
  - **重要**: 「発行」ボタンを押すと、Stripe Invoicing APIを使用して請求書を発行し、**Stripeの支払い情報（口座振込先情報）**が印字されたPDFが生成される
  - 入金時には送金者名（口座名義）が自動的に仕入先名として表示・保存される
- **パートナー承認 (Partner Settings)**:
  - 提携申請の承認/拒否
  - 個別報酬レートの設定（例：このパートナーだけ30%にする等）

## 8. 法的構成・利用規約（Legal Scheme）

システム開発と同じくらい重要なのが、「資金決済法違反」にならないための法的ロジックです。  
※必ず顧問弁護士のリーガルチェックを経て確定させてください。以下の条文構成は一般的な収納代行モデルのひな形です。

### 8.1. 収納代行に関する特約（Vendor向け）

プラットフォーム（あなた）が、Vendor（売り手）に代わって代金を受け取る根拠を作ります。

**第X条（収納代行および弁済の効力）**

ユーザー（Vendor）は、本サービスを通じて発生した取引について、プラットフォーム運営者（Admin）が代金の収納代行を行うことに同意する。AdminがClientから代金を受領した時点で、Vendorに対する弁済の効力が生じるものとする。

---

*本ドキュメントは、システム開発の基本設計書として作成されています。実装前に、必ず法的・技術的なレビューを実施してください。*
