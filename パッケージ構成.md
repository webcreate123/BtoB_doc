# パッケージ構成

## プロジェクト全体構成

本プロジェクトは、BtoB紹介パートナープラットフォームのためのモノレポ構成となっており、以下の4つの主要パッケージで構成されています。

```
BtoB/
├── BtoB_backend/      # バックエンドAPI（Go）
├── BtoB_frontend/     # フロントエンド（Next.js - パートナー/ベンダー向け）
├── BtoB_admin/        # 管理画面（Next.js - 管理者向け）
└── BtoB_doc/          # ドキュメント
```

---

## 1. BtoB_backend

### 1.1. 概要
- **言語**: Go 1.24.0
- **フレームワーク**: Gin
- **データベース**: PostgreSQL (GORM)
- **主要ライブラリ**: 
  - Stripe API (決済処理)
  - JWT (認証)
  - golang-migrate (DBマイグレーション)
  - gofpdf (PDF生成)

### 1.2. ディレクトリ構成

```
BtoB_backend/
├── cmd/
│   ├── server/
│   │   └── main.go              # メインサーバーエントリーポイント
│   └── migrate/
│       └── main.go              # データベースマイグレーション実行
├── internal/
│   ├── database/
│   │   └── database.go          # データベース接続・初期化
│   ├── handlers/                # HTTPハンドラー層
│   │   ├── admin.go            # 管理者向けAPI
│   │   ├── auth.go             # 認証関連API
│   │   ├── billing.go          # 請求・入金管理API
│   │   ├── chat.go             # チャット機能API
│   │   ├── deal.go             # 案件管理API
│   │   ├── partner.go          # パートナー管理API
│   │   ├── payout.go           # 支払い処理API
│   │   ├── stripe_connect.go   # Stripe Connect連携API
│   │   └── webhook.go          # Webhook受信処理
│   ├── middleware/
│   │   └── auth.go             # 認証ミドルウェア
│   ├── models/                  # データモデル定義
│   │   ├── audit_log.go        # 監査ログ
│   │   ├── chat.go             # チャット
│   │   ├── deal.go             # 案件
│   │   ├── invoice.go          # 請求書
│   │   ├── partner_approval.go # パートナー承認
│   │   ├── partner_pool.go     # パートナープール
│   │   ├── payout.go           # 支払い
│   │   ├── platform_settings.go # プラットフォーム設定
│   │   ├── referral_link.go    # 紹介リンク
│   │   ├── transaction.go      # 取引
│   │   ├── user.go             # ユーザー
│   │   └── virtual_account.go  # バーチャル口座
│   ├── services/                # ビジネスロジック層
│   │   ├── distribution.go     # 報酬分配ロジック
│   │   ├── notification.go     # 通知処理
│   │   ├── pdf.go              # PDF生成サービス
│   │   └── stripe.go           # Stripe統合サービス
│   └── utils/                   # ユーティリティ
│       ├── calculation.go      # 計算処理
│       ├── jwt.go              # JWT処理
│       └── password.go         # パスワード処理
├── migrations/                   # データベースマイグレーションファイル
│   └── [30 SQL files]
├── Dockerfile
├── Makefile
├── go.mod
└── go.sum
```

### 1.3. レイヤー構造

1. **cmd/**: アプリケーションのエントリーポイント
   - `server/main.go`: HTTPサーバー起動、ルーティング設定
   - `migrate/main.go`: データベースマイグレーション実行

2. **internal/handlers/**: HTTPリクエストハンドラー
   - リクエストの受信、バリデーション、レスポンス返却を担当
   - ビジネスロジックはservices層に委譲

3. **internal/services/**: ビジネスロジック層
   - 報酬分配、通知送信、PDF生成、Stripe連携などの核心処理

4. **internal/models/**: データモデル
   - GORMを使用したデータベースモデル定義

5. **internal/middleware/**: ミドルウェア
   - 認証・認可処理

6. **internal/utils/**: 共通ユーティリティ
   - JWT、パスワードハッシュ、計算処理など

---

## 2. BtoB_frontend

### 2.1. 概要
- **フレームワーク**: Next.js 16.0 (App Router)
- **言語**: TypeScript
- **状態管理**: Zustand
- **スタイリング**: Tailwind CSS
- **主要ライブラリ**:
  - axios (HTTP通信)
  - react-hook-form (フォーム管理)
  - @dnd-kit (ドラッグ&ドロップ)
  - recharts (グラフ表示)
  - jspdf (PDF生成)

### 2.2. ディレクトリ構成

```
BtoB_frontend/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # ルートレイアウト
│   ├── page.tsx                 # トップページ
│   ├── globals.css              # グローバルスタイル
│   ├── login/
│   │   └── page.tsx             # ログインページ
│   ├── register/
│   │   └── page.tsx            # 会員登録ページ
│   ├── partner/                 # パートナー向けページ
│   │   ├── layout.tsx          # パートナーレイアウト
│   │   ├── dashboard/
│   │   │   └── page.tsx        # ダッシュボード
│   │   ├── deals/              # 案件管理
│   │   │   ├── page.tsx        # 案件一覧
│   │   │   ├── new/
│   │   │   │   └── page.tsx    # 新規案件登録
│   │   │   └── [id]/
│   │   │       └── page.tsx    # 案件詳細
│   │   ├── approvals/
│   │   │   └── page.tsx        # 承認待ち一覧
│   │   ├── referrals/
│   │   │   └── page.tsx        # 紹介リンク管理
│   │   └── wallet/
│   │       └── page.tsx        # ウォレット（報酬確認）
│   ├── vendor/                  # ベンダー向けページ
│   │   ├── layout.tsx          # ベンダーレイアウト
│   │   ├── dashboard/
│   │   │   └── page.tsx        # ダッシュボード
│   │   ├── deals/              # 案件管理
│   │   │   ├── page.tsx        # 案件一覧
│   │   │   └── [id]/
│   │   │       └── page.tsx    # 案件詳細
│   │   ├── approvals/
│   │   │   └── page.tsx        # 承認待ち一覧
│   │   └── billing/
│   │       └── page.tsx        # 請求管理
│   └── stripe/                  # Stripe連携
│       └── onboarding/
│           ├── return/
│           │   └── page.tsx    # Stripe Connect リターン
│           └── refresh/
│               └── page.tsx    # リフレッシュ
├── components/                   # 再利用可能コンポーネント
│   ├── Layout.tsx              # 共通レイアウトコンポーネント
│   ├── ChatBox.tsx             # チャットボックス
│   └── Notification.tsx        # 通知コンポーネント
├── lib/
│   └── api.ts                  # APIクライアント（axios設定）
├── store/
│   └── authStore.ts            # 認証状態管理（Zustand）
├── hooks/
│   └── useRequireAuth.ts       # 認証必須フック
├── package.json
├── tsconfig.json
├── tailwind.config.js
├── next.config.js
└── Dockerfile
```

### 2.3. 主要機能

- **パートナー機能**: 案件紹介、進捗確認、報酬確認
- **ベンダー機能**: 案件管理、商談、請求書発行、入金確認
- **認証**: JWTベースの認証システム
- **リアルタイム通信**: チャット機能

---

## 3. BtoB_admin

### 3.1. 概要
- **フレームワーク**: Next.js 16.0 (App Router)
- **言語**: TypeScript
- **状態管理**: Zustand
- **スタイリング**: Tailwind CSS
- **ポート**: 3001 (フロントエンドは3000)

### 3.2. ディレクトリ構成

```
BtoB_admin/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # ルートレイアウト
│   ├── page.tsx                 # トップページ
│   ├── globals.css              # グローバルスタイル
│   ├── login/
│   │   └── page.tsx             # 管理者ログイン
│   ├── dashboard/
│   │   └── page.tsx            # 管理ダッシュボード
│   ├── transactions/
│   │   └── page.tsx            # 取引一覧・監視
│   ├── manual-match/
│   │   └── page.tsx            # 手動マッチング（入金処理）
│   └── settings/
│       └── page.tsx            # プラットフォーム設定
├── components/
│   └── Layout.tsx              # 管理画面レイアウト
├── lib/
│   └── api.ts                  # APIクライアント
├── store/
│   └── authStore.ts            # 認証状態管理
├── package.json
├── tsconfig.json
└── tailwind.config.js
```

### 3.3. 主要機能

- **ダッシュボード**: システム全体の統計情報
- **取引監視**: 全取引の監視・確認
- **手動マッチング**: 自動処理失敗時の手動入金マッチング
- **設定管理**: プラットフォーム手数料率などの設定

---

## 4. BtoB_doc

### 4.1. 概要
プロジェクトのドキュメントを管理するディレクトリ

### 4.2. ファイル構成

```
BtoB_doc/
├── パッケージ構成.md          # 本ドキュメント
├── 要件定義書_version.md     # 要件定義書
└── 実装状況.md               # 実装状況の記録
```

---

## 5. データフロー

### 5.1. リクエストフロー

```
Frontend/Admin
    ↓ (HTTP Request)
Backend Handlers
    ↓ (Validation)
Backend Services
    ↓ (Business Logic)
Database (via GORM)
    ↓ (Response)
Backend Handlers
    ↓ (JSON Response)
Frontend/Admin
```

### 5.2. 認証フロー

1. ユーザーがログイン → `handlers/auth.go`
2. JWTトークン生成 → `utils/jwt.go`
3. トークンをクライアントに返却
4. 以降のリクエストで `middleware/auth.go` が検証

### 5.3. 決済フロー

1. 案件成立 → `handlers/deal.go`
2. バーチャル口座発行 → `services/stripe.go`
3. 請求書生成 → `services/pdf.go`
4. 入金検知 → `handlers/webhook.go`
5. 報酬分配計算 → `services/distribution.go`
6. 自動送金実行 → `handlers/payout.go`

---

## 6. 外部サービス連携

### 6.1. Stripe
- **用途**: 決済処理、Stripe Connect（パートナーへの送金）
- **実装**: `internal/services/stripe.go`
- **Webhook**: `internal/handlers/webhook.go`

### 6.2. GMOあおぞらネット銀行 API
- **用途**: バーチャル口座発行、入金通知、振込処理
- **実装**: `internal/services/stripe.go` (将来的に分離予定)

---

## 7. データベース

### 7.1. マイグレーション
- **ツール**: golang-migrate
- **実行**: `go run cmd/migrate/main.go`
- **場所**: `migrations/` (30ファイル)

### 7.2. 主要テーブル
- `users`: ユーザー情報
- `deals`: 案件情報
- `transactions`: 取引履歴
- `payouts`: 支払い履歴
- `virtual_accounts`: バーチャル口座
- `invoices`: 請求書
- `chats`: チャットメッセージ
- `partner_approvals`: パートナー承認
- `audit_logs`: 監査ログ

---

## 8. 環境変数

### 8.1. Backend (.env)
- データベース接続情報
- JWT秘密鍵
- Stripe API キー
- GMOあおぞら銀行 API キー

### 8.2. Frontend/Admin (.env.local)
- バックエンドAPI URL
- その他の設定

---

## 9. デプロイメント

### 9.1. Docker
- `BtoB_backend/Dockerfile`: バックエンド用
- `BtoB_frontend/Dockerfile`: フロントエンド用

### 9.2. その他
- `DEPLOYMENT.md`: デプロイ手順
- `PROJECT_SETUP.md`: セットアップ手順
